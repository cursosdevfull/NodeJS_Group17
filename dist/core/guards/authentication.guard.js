"use strict";var __awaiter=this&&this.__awaiter||function(t,e,s,a){return new(s||(s=Promise))((function(o,r){function n(t){try{u(a.next(t))}catch(t){r(t)}}function i(t){try{u(a.throw(t))}catch(t){r(t)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(n,i)}u((a=a.apply(t,e||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AuthenticationGuard=void 0;const status_jwt_1=require("../services/status-jwt"),tokens_1=require("../services/tokens");class AuthenticationGuard{execute2FA(t){return{canActivate(e,s,a){return __awaiter(this,void 0,void 0,(function*(){var o,r;const{authorization:n}=e.headers;if(!AuthenticationGuard.isTokenAdded(n))return s.status(401).json({message:"Unauthorized"});try{const e=yield AuthenticationGuard.isTokenValid(n,t);if(200!==e.statusCode)return s.status(e.statusCode).json({message:e.error});s.locals.userId=null===(o=e.payload)||void 0===o?void 0:o.userId,s.locals.roles=null===(r=e.payload)||void 0===r?void 0:r.roles,a()}catch(t){return s.status(t.statusCode).json({message:t.error})}}))}}}static isTokenAdded(t){return!(!t||"Bearer"!==t.split(" ")[0]||!t.split(" ")[1])}static isTokenValid(t,e){return new Promise(((s,a)=>__awaiter(this,void 0,void 0,(function*(){try{const a=yield tokens_1.Tokens.verifyToken(t.split(" ")[1]);e&&!a.enable2FA?s({statusCode:428,error:"2FA is not enabled",payload:null}):s({statusCode:200,error:null,payload:a})}catch(t){t.message===status_jwt_1.StatusJwt.JWT_EXPIRED?a({statusCode:409,error:"Token expired",payload:null}):a({statusCode:401,error:"Unauthorized",payload:null})}}))))}}exports.AuthenticationGuard=AuthenticationGuard;