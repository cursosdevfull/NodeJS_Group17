"use strict";var __awaiter=this&&this.__awaiter||function(e,r,t,o){return new(t||(t=Promise))((function(s,a){function n(e){try{_(o.next(e))}catch(e){a(e)}}function i(e){try{_(o.throw(e))}catch(e){a(e)}}function _(e){var r;e.done?s(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(n,i)}_((o=o.apply(e,r||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.UserInfrastructure=void 0;const neverthrow_1=require("neverthrow"),typeorm_1=require("typeorm"),database_bootstrap_1=require("../../../bootstrap/database.bootstrap"),exception_1=require("../../../core/handle-errors/responses/exception"),logger_1=require("../../../core/utils/logger"),user_dto_1=require("./dtos/user.dto"),user_entity_1=require("./entities/user.entity");class UserInfrastructure{constructor(){this.logger=logger_1.Logger.createLogger()}save(e){return __awaiter(this,void 0,void 0,(function*(){var r;try{const r=database_bootstrap_1.DatabaseBootstrap.getDataSource().getRepository(user_entity_1.UserEntity),t=user_dto_1.UserDto.fromDomainToData(e),o=yield r.save(t);return(0,neverthrow_1.ok)(user_dto_1.UserDto.fromDataToDomain(o))}catch(e){return this.logger.logError("Error saving user",e),(0,neverthrow_1.err)(new exception_1.InternalServerErrorException({message:null!==(r=e.sqlMessage)&&void 0!==r?r:exception_1.MESSAGE_STATUS.INTERNAL_SERVER_ERROR,name:"ERROR DATABASE"}))}}))}getAll(){return __awaiter(this,void 0,void 0,(function*(){var e;try{const e=database_bootstrap_1.DatabaseBootstrap.getDataSource().getRepository(user_entity_1.UserEntity),r=yield e.find({where:{deletedAt:(0,typeorm_1.IsNull)()},relations:["roles"]});return(0,neverthrow_1.ok)(user_dto_1.UserDto.fromDataToDomain(r))}catch(r){return this.logger.logError("Error saving user",r),(0,neverthrow_1.err)(new exception_1.InternalServerErrorException({message:null!==(e=r.sqlMessage)&&void 0!==e?e:exception_1.MESSAGE_STATUS.INTERNAL_SERVER_ERROR,name:""}))}}))}getById(e){return __awaiter(this,void 0,void 0,(function*(){var r;try{const r=database_bootstrap_1.DatabaseBootstrap.getDataSource().getRepository(user_entity_1.UserEntity),t=yield r.findOne({where:{deletedAt:(0,typeorm_1.IsNull)(),userId:e},relations:["roles"]});return(0,neverthrow_1.ok)(user_dto_1.UserDto.fromDataToDomain(t))}catch(e){return this.logger.logError("Error saving user",e),(0,neverthrow_1.err)(new exception_1.InternalServerErrorException({message:null!==(r=e.sqlMessage)&&void 0!==r?r:exception_1.MESSAGE_STATUS.INTERNAL_SERVER_ERROR,name:""}))}}))}getByEmail(e){return __awaiter(this,void 0,void 0,(function*(){var r;try{const r=database_bootstrap_1.DatabaseBootstrap.getDataSource().getRepository(user_entity_1.UserEntity),t=yield r.findOne({where:{deletedAt:(0,typeorm_1.IsNull)(),email:e},relations:["roles"]});return(0,neverthrow_1.ok)(user_dto_1.UserDto.fromDataToDomain(t))}catch(e){return this.logger.logError("Error saving user",e),(0,neverthrow_1.err)(new exception_1.InternalServerErrorException({message:null!==(r=e.sqlMessage)&&void 0!==r?r:exception_1.MESSAGE_STATUS.INTERNAL_SERVER_ERROR,name:""}))}}))}getByRefreshToken(e){return __awaiter(this,void 0,void 0,(function*(){var r;try{const r=database_bootstrap_1.DatabaseBootstrap.getDataSource().getRepository(user_entity_1.UserEntity),t=yield r.findOne({where:{deletedAt:(0,typeorm_1.IsNull)(),refreshToken:e},relations:["roles"]});return(0,neverthrow_1.ok)(user_dto_1.UserDto.fromDataToDomain(t))}catch(e){return this.logger.logError("Error saving user",e),(0,neverthrow_1.err)(new exception_1.InternalServerErrorException({message:null!==(r=e.sqlMessage)&&void 0!==r?r:exception_1.MESSAGE_STATUS.INTERNAL_SERVER_ERROR,name:""}))}}))}getByPage(e,r){return __awaiter(this,void 0,void 0,(function*(){var t;try{const t=database_bootstrap_1.DatabaseBootstrap.getDataSource().getRepository(user_entity_1.UserEntity),[o,s]=yield t.findAndCount({where:{deletedAt:(0,typeorm_1.IsNull)()},skip:e*r,take:r,relations:["roles"]});return(0,neverthrow_1.ok)(user_dto_1.UserDto.fromDataToDomain(o))}catch(e){return this.logger.logError("Error saving user",e),(0,neverthrow_1.err)(new exception_1.InternalServerErrorException({message:null!==(t=e.sqlMessage)&&void 0!==t?t:exception_1.MESSAGE_STATUS.INTERNAL_SERVER_ERROR,name:""}))}}))}}exports.UserInfrastructure=UserInfrastructure;